define("local_catquiz/syncscale",["exports","core/str","core/ajax","core/notification","core/modal_factory","core/modal_events","core/templates"],(function(_exports,_str,_ajax,_notification,_modal_factory,_modal_events,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @package    local_catquiz
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates);const SELECTORS_SYNCBUTTON="#sync_button";_exports.init=config=>{const centralHost=config.centralHost,syncButton=document.querySelector(SELECTORS_SYNCBUTTON);syncButton&&syncButton.addEventListener("click",(()=>{fetchParameters(centralHost)}))};const fetchParameters=async centralHost=>{const scaleid=new URLSearchParams(window.location.search).get("scaleid");let modal=null;const fetchMessage=await(0,_str.get_string)("fetchingparameters","local_catquiz");try{modal=await _modal_factory.default.create({title:await(0,_str.get_string)("fetchparamheading","local_catquiz",centralHost),body:`<div class="text-center"><i class="fa fa-spinner fa-spin fa-2x"></i><p>${fetchMessage}</p></div>`,removeOnClose:!0,type:_modal_factory.default.types.DEFAULT}),modal.show();const result=await _ajax.default.call([{methodname:"local_catquiz_client_fetch_parameters",args:{scaleid:scaleid}}])[0];if(result.error)throw new Error(result.error);if(!result||void 0===result.status)throw new Error(await(0,_str.get_string)("invalidresponse","local_catquiz"));const aggregatedWarnings=(warnings=>{const warningMap=new Map;let index=0;return warnings.forEach((warning=>{const key=warning.warning;if(warningMap.has(key)){const existingWarning=warningMap.get(key);existingWarning.uniqueItems.add(warning.item),existingWarning.items=Array.from(existingWarning.uniqueItems),existingWarning.count++}else warningMap.set(key,{message:warning.warning,count:1,uniqueItems:new Set([warning.item]),items:[warning.item],index:index++})})),Array.from(warningMap.values()).map((_ref=>{let{message:message,count:count,items:items,index:index}=_ref;return{message:message,count:count,items:items,index:index,multipleItems:items.length>1}}))})(result.warnings),content=await _templates.default.render("local_catquiz/fetch_parameters_result",{status:result.status,message:result.message,duration:result.duration,synced:result.synced,errors:result.errors,warnings:aggregatedWarnings,hasWarnings:aggregatedWarnings.length>0});modal.setTitle(await(0,_str.get_string)("fetchparamheading","local_catquiz",centralHost)),modal.setBody(content);const footer=modal.getFooter();footer.empty();const closeButton='<button class="btn btn-primary" data-action="hide">'+await(0,_str.get_string)("close","core")+"</button>";footer.append(closeButton),document.querySelector(SELECTORS_SYNCBUTTON).setAttribute("disabled",!0),modal.getRoot().on(_modal_events.default.hidden,(()=>{result.status&&window.location.reload()}))}catch(error){if(modal){const errorMessage=error.message||await(0,_str.get_string)("unknownerror","local_catquiz");try{const errorContent=await _templates.default.render("local_catquiz/fetch_parameters_result",{status:!1,message:errorMessage,duration:0,synced:0,errors:1,warnings:[],hasWarnings:!1});modal.setTitle(await(0,_str.get_string)("error","core")),modal.setBody(errorContent);const footer=modal.getFooter();footer.empty();const closeButton='<button class="btn btn-primary" data-action="hide">'+await(0,_str.get_string)("close","core")+"</button>";footer.append(closeButton)}catch(templateError){modal.setBody('<div class="alert alert-danger">'+errorMessage+"</div>")}}else _notification.default.exception(error)}}}));

//# sourceMappingURL=syncscale.min.js.map