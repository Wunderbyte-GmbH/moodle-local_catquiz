define("local_catquiz/testitem_model_overrides",["exports","core_form/dynamicform","core/str"],(function(_exports,_dynamicform,_str){var obj;
/*
   * @package    local_catquiz
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_dynamicform=(obj=_dynamicform)&&obj.__esModule?obj:{default:obj};const SELECTORS_FORMCONTAINER="#lcq_model_override_form",SELECTORS_NOEDITBUTTON='[name="noedititemparams"]',SELECTORS_MODELSTATUSSELECTS='#lcq_model_override_form .custom-select[name^="override_"]',SELECTORS_ACTIVEMODELSELECT='[name="active_model"]',SELECTORS_TEMP_FIELDS_INPUT='[name="temporaryfields"]',SELECTORS_DELETED_PARAMS_FIELD='[name="deletedparams"]',disabledStates=["0","-5"],syncSelectedState=model=>{const selected=model.value,selectorModel=model.id.match(/id_override_(.*)_select/)[1];let optionUpdateFun=option=>option.removeAttribute("disabled");disabledStates.includes(selected)&&(optionUpdateFun=option=>option.setAttribute("disabled","disabled"));document.querySelector(SELECTORS_ACTIVEMODELSELECT).options.forEach((o=>{o.value!=selectorModel||optionUpdateFun(o)}))},deleteParameters=(model,index)=>{const tempFieldsInput=document.querySelector(SELECTORS_TEMP_FIELDS_INPUT);let tempids=JSON.parse(tempFieldsInput.value),filtered=tempids.filter((newparams=>newparams.model!=model&&newparams.index!=index));if(tempFieldsInput.value=JSON.stringify(filtered),filtered.length!=tempids.length)return;const deletedParamsField=document.querySelector(SELECTORS_DELETED_PARAMS_FIELD);let deletedParams=JSON.parse(deletedParamsField.value);const deleteParam={model:model,index:index};deletedParams.push(deleteParam),deletedParamsField.value=JSON.stringify(deletedParams)};_exports.init=()=>{const dynamicForm=new _dynamicform.default(document.querySelector(SELECTORS_FORMCONTAINER),"local_catquiz\\form\\item_model_override_selector"),switchEditMode=targetModeIsEditing=>{const searchParams=new URLSearchParams(window.location.search);dynamicForm.load({editing:targetModeIsEditing,testitemid:searchParams.get("id"),contextid:searchParams.get("contextid"),scaleid:searchParams.get("scaleid"),component:searchParams.get("component"),updateitem:!0}).then((result=>(document.querySelectorAll(SELECTORS_MODELSTATUSSELECTS).forEach((model=>{syncSelectedState(model),model.addEventListener("change",(e=>syncSelectedState(e.target))),model.addEventListener("change",(e=>(element=>{const model=element.id.match(/id_override_(.*)_select/)[1],disabled=1==element.value;[...document.querySelectorAll(`input[name^="override_${model}["]`),...document.querySelectorAll(`button[data-model="${model}"]`),document.querySelector(`input[value="Add"][data-model="${model}"]`)].forEach((e=>{disabled?e.setAttribute("disabled","disabled"):e.removeAttribute("disabled")}))})(e.target)))})),document.querySelectorAll("#lcq_model_override_form .param-group .align-items-center").forEach((async container=>{if(!container.querySelector('input[type^="fraction_"]'))return;const addButton=container.querySelector('[data-action="additemparams"]'),modelName=(null==addButton?void 0:addButton.getAttribute("data-model"))||"",elements=Array.from(container.children),restructured=[];let pairCounter=0;for(let i=0;i<elements.length;i++){var _elements,_elements$getAttribut;const currentElement=elements[i];if(currentElement.querySelector('[data-action="additemparams"]'))restructured.push(currentElement.cloneNode(!0));else if("LABEL"===currentElement.tagName&&"INPUT"===(null===(_elements=elements[i+1])||void 0===_elements?void 0:_elements.tagName)&&null!==(_elements$getAttribut=elements[i+1].getAttribute("type"))&&void 0!==_elements$getAttribut&&_elements$getAttribut.startsWith("fraction_")){var _nextInput$getAttribu;const nextLabel=elements[i+3],nextInput=elements[i+4];if(null!=nextInput&&null!==(_nextInput$getAttribu=nextInput.getAttribute("type"))&&void 0!==_nextInput$getAttribu&&_nextInput$getAttribu.startsWith("difficulty_")){const pairDiv=document.createElement("div");pairDiv.className="param-pair";const wrapper1=document.createElement("div");wrapper1.className="input-wrapper",wrapper1.appendChild(currentElement.cloneNode(!0)),wrapper1.appendChild(elements[i+1].cloneNode(!0));const wrapper2=document.createElement("div");wrapper2.className="input-wrapper",wrapper2.appendChild(nextLabel.cloneNode(!0)),wrapper2.appendChild(nextInput.cloneNode(!0));const deleteBtn=document.createElement("button");deleteBtn.className="btn btn-danger param-delete",deleteBtn.textContent="Delete";try{deleteBtn.textContent=await(0,_str.get_string)("delete")}catch(error){}deleteBtn.setAttribute("data-param-num",pairCounter),deleteBtn.setAttribute("data-model",modelName),deleteBtn.onclick=function(){const model=this.dataset.model,paramNum=this.dataset.paramNum;deleteParameters(model,paramNum),pairDiv.remove()},pairDiv.appendChild(wrapper1),pairDiv.appendChild(wrapper2),pairDiv.appendChild(deleteBtn),restructured.push(pairDiv),i+=4,pairCounter++}}else currentElement.classList.contains("break")&&restructured.push(currentElement.cloneNode(!0))}container.innerHTML="",restructured.forEach((element=>container.appendChild(element)))})),result))).catch((err=>err))},addItemParams=e=>{const lastBreak=e.detail.parentElement.parentElement.previousElementSibling,existingInputs=e.detail.closest(".param-group").querySelectorAll('input[type^="fraction_"], input[type^="difficulty_"]'),currentMax=Math.max(...Array.from(existingInputs).map((input=>parseInt(input.getAttribute("type").split("_")[1]||"0")))),newNumber=currentMax+1,pairDiv=document.createElement("div");pairDiv.className="param-pair";const fielddata=e.detail.dataset.fields.split(";");let newIds=[];fielddata.forEach((field=>{const fieldarr=field.split(":"),internalName=fieldarr[0],label=fieldarr[1],newLabel=document.createElement("label");newLabel.textContent=`${label} ${newNumber}`,newLabel.setAttribute("for",`${internalName}_${newNumber}`);const newInput=document.createElement("input");newInput.className="form-control param-input",newInput.id=`${internalName}_${newNumber}`,newInput.setAttribute("type",`${internalName}_${newNumber}`);const wrapper=document.createElement("div");wrapper.className="input-wrapper",wrapper.appendChild(newLabel),wrapper.appendChild(newInput),pairDiv.appendChild(wrapper),newIds.push(newInput.id)}));const deleteBtn=document.createElement("button");deleteBtn.className="btn btn-danger param-delete",deleteBtn.textContent="Delete",deleteBtn.setAttribute("data-param-num",currentMax),deleteBtn.setAttribute("data-param-model",e.detail.dataset.model),deleteBtn.onclick=function(){const model=this.dataset.model,paramNum=this.dataset.paramNum;deleteParameters(model,paramNum),pairDiv.remove()},pairDiv.appendChild(deleteBtn),lastBreak.insertAdjacentElement("afterend",pairDiv);const newBreak=document.createElement("span");newBreak.className="break new-break",pairDiv.insertAdjacentElement("afterend",newBreak);const tempFieldsInput=document.querySelector(SELECTORS_TEMP_FIELDS_INPUT);let tempids=JSON.parse(tempFieldsInput.value);const tempData={model:e.detail.dataset.model,ids:newIds,index:currentMax};tempids.push(tempData),tempFieldsInput.value=JSON.stringify(tempids)};dynamicForm.addEventListener(dynamicForm.events.SUBMIT_BUTTON_PRESSED,(()=>{const tempFieldsInput=document.querySelector(SELECTORS_TEMP_FIELDS_INPUT),newParamData=(addedParamIds=>{let finalData={};return addedParamIds.forEach((newParam=>{const model=newParam.model;finalData[model]=finalData[model]||[];const ids=newParam.ids,params={};ids.forEach((id=>{const value=document.getElementById(id).value;params[id]=value})),finalData[model].push(params)})),finalData})(JSON.parse(tempFieldsInput.value));tempFieldsInput.value=JSON.stringify(newParamData)})),dynamicForm.addEventListener(dynamicForm.events.FORM_SUBMITTED,(e=>{e.preventDefault();let formcontainer=document.querySelector(SELECTORS_FORMCONTAINER);const searchParams=new URLSearchParams(window.location.search);dynamicForm.load({editing:!formcontainer.querySelector(SELECTORS_NOEDITBUTTON),testitemid:searchParams.get("id"),contextid:searchParams.get("contextid"),scaleid:searchParams.get("scaleid"),component:searchParams.get("component"),updateitem:!0}).then((result=>result)).catch((err=>err))})),dynamicForm.addEventListener(dynamicForm.events.NOSUBMIT_BUTTON_PRESSED,(e=>{e.preventDefault();const action=e.detail.dataset.action,targetModeIsEditing="edititemparams"==e.detail.name;switch(action){case"edititemparams":switchEditMode(targetModeIsEditing);break;case"additemparams":addItemParams(e);break;default:console.error(`Unknown no-submit action: ${action}`)}}))}}));

//# sourceMappingURL=testitem_model_overrides.min.js.map